___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Shoparize Website Tracking API",
  "categories": [
    "ADVERTISING",
    "AFFILIATE_MARKETING",
    "CONVERSIONS"
  ],
  "brand": {
    "id": "shoparize",
    "displayName": "Shoparize",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "This (unofficial) GTM Template is for Shop Owners using Shoparize to integrate the Shoparize Website Tracking API into your Website.\nMore Info: https://github.com/Andiministrator/Shoparize",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "partner_id",
    "displayName": "Shoparize Partner ID",
    "simpleValueType": true,
    "alwaysInSummary": true,
    "notSetText": "Please provide your Shoparize Partner ID"
  },
  {
    "type": "SELECT",
    "name": "pagetype",
    "displayName": "Page Type",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "normal",
        "displayValue": "Normal Page"
      },
      {
        "value": "purchase",
        "displayValue": "Purchase Page"
      }
    ],
    "simpleValueType": true,
    "alwaysInSummary": true
  },
  {
    "type": "SELECT",
    "name": "ecomm_datalayer",
    "displayName": "ECommerce DataLayer",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "default",
        "displayValue": "Default DataLayer"
      },
      {
        "value": "manual",
        "displayValue": "Manual Setup"
      }
    ],
    "simpleValueType": true,
    "alwaysInSummary": true,
    "help": "Provide your ECommerce Object.\u003cbr /\u003e\u003cbr /\u003e\n\nUse \"Default DataLayer\" for using the Standard ECommerce DataLayer of the Google Tag Manager (\u003cpre\u003edataLayer.ecommerce\u003c/pre\u003e).\u003cbr /\u003e\u003cbr /\u003e\n\nOr use \"Manual Setup\" to select all fields by your own.\u003cbr /\u003e\u003cbr /\u003e\n\nIf you have an separate ECommerce Object, you can select it from your GTM Variables.\u003cbr /\u003e\nThe Object should have the following fields and format (example):\u003cbr /\u003e\n\u003cpre\u003e{\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;transaction_id: \"t123\",\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;value: 39.48,\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;tax: 6.31,\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;shipping: 4.99,\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;currency: \"EUR\",\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;items: [\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;{\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;item_id: \"p42_1234\",\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;item_name: \"Shoparize Shirt white\",\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;currency: \"EUR\",\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;price: 29.49,\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;quantity: 1\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;},\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;{\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;item_id: \"p43_11\",\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;item_name: \"Shoparize Basecap\",\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;currency: \"EUR\",\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;price: 9.99,\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;quantity: 1\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;}\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;]\u003cbr /\u003e\n}\u003cbr /\u003e\n\u003c/pre\u003e",
    "subParams": [
      {
        "type": "LABEL",
        "name": "spaceholder2",
        "displayName": ""
      },
      {
        "type": "GROUP",
        "name": "ecomm_fields",
        "displayName": "Manual Setup for ECommerce Object",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "TEXT",
            "name": "transaction_id",
            "displayName": "Transaction ID",
            "simpleValueType": true,
            "help": "The Order ID"
          },
          {
            "type": "TEXT",
            "name": "currency",
            "displayName": "Currency",
            "simpleValueType": true,
            "help": "The Currency Code (ISO 4217)\u003cbr /\u003e\nE.g.: EUR\u003cbr /\u003e\u003cbr /\u003e\nCurrency Code List: https://www.iso.org/iso-4217-currency-codes.html"
          },
          {
            "type": "TEXT",
            "name": "revenue",
            "displayName": "Revenue (Total Value)",
            "simpleValueType": true,
            "help": "The Total Value of the Order, e.g.: 29.49",
            "valueValidators": [
              {
                "type": "REGEX",
                "args": [
                  "\\d+(\\.\\d+)?"
                ],
                "errorMessage": "Provide a value in the format 29.49"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "tax",
            "displayName": "Tax",
            "simpleValueType": true,
            "help": "The Tax, e.g.: 4.71",
            "valueValidators": [
              {
                "type": "REGEX",
                "args": [
                  "\\d+(\\.\\d+)?"
                ],
                "errorMessage": "Provide a value in the format 29.49"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "shipping",
            "displayName": "Shipping Costs",
            "simpleValueType": true,
            "help": "The Shipping Costs, e.g.: 4.99",
            "valueValidators": [
              {
                "type": "REGEX",
                "args": [
                  "\\d+(\\.\\d+)?"
                ],
                "errorMessage": "Provide a value in the format 29.49"
              }
            ]
          },
          {
            "type": "SELECT",
            "name": "items",
            "displayName": "Item (Product) Array",
            "macrosInSelect": true,
            "selectItems": [
              {
                "value": "default",
                "displayValue": "Default (GTM ECommerce DataLayer)"
              },
              {
                "value": "datalayer",
                "displayValue": "DataLayer Field"
              }
            ],
            "simpleValueType": true,
            "help": "Or provide the item (product) array with an own Variable. It should have the following fields and format (example):\u003cbr /\u003e\n\u003cpre\u003e\n[\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;{\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;item_id: \"p42_1234\",\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;item_name: \"Shoparize Shirt white\",\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;currency: \"EUR\",\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;price: 29.49,\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;quantity: 1\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;},\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;{\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;item_id: \"p43_11\",\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;item_name: \"Shoparize Basecap\",\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;currency: \"EUR\",\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;price: 9.99,\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;quantity: 1\u003cbr /\u003e\n\u0026nbsp;\u0026nbsp;}\u003cbr /\u003e\n]\u003cbr /\u003e\n\u003c/pre\u003e"
          },
          {
            "type": "TEXT",
            "name": "item_field",
            "displayName": "DataLayer Field with Product Array",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "items",
                "paramValue": "datalayer",
                "type": "EQUALS"
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "ecomm_datalayer",
            "paramValue": "manual",
            "type": "EQUALS"
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "pagetype",
        "paramValue": "purchase",
        "type": "EQUALS"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Required Libraries
const log = require('logToConsole');
const injectScript = require('injectScript');
const callInWindow = require('callInWindow');
const copyFromWindow = require('copyFromWindow');
const setInWindow = require('setInWindow');
const copyFromDataLayer = require('copyFromDataLayer');
const queryPermission = require('queryPermission');
const JSON = require('JSON');

// Configuration
const shoparize_url = 'https://partner-cdn.shoparize.com/js/shoparize.js';
const partner_id = data.partner_id;
const pagetype = data.pagetype;

// Shoparize Tracking (Main) Function
const trackShoparize = function() {

  // Get Shoparize API
  let srapi = callInWindow('SHOPARIZE_API');
  if (typeof srapi == 'undefined') {
    log('error', 'Error by calling SHOPARIZE_API. Returns undefined (Type: '+typeof srapi+').');
    data.gtmOnFailure();
  }
  //log('info', 'Shoparize Script for '+partner_id+' injected', typeof srapi);

  // Normal Pageview
  if (pagetype=='normal') {
    // Run Shoparize Init
    if (typeof srapi == 'object' && typeof srapi.init == 'function') {
      srapi.init(partner_id);
    } else {
      log('error', 'Error by calling SHOPARIZE_API.init');
      data.gtmOnFailure();
    }
    //log('info', 'Shoparize Init for Pageview sent');
  }

  // Purchase Pageview
  if (pagetype=='purchase') {
    // Run Shoparize Init
    if (typeof srapi == 'object' && typeof srapi.init == 'function') {
      srapi.init(partner_id);
    } else {
      log('error', 'Error by calling SHOPARIZE_API.init');
      data.gtmOnFailure();
    }
    //log('info', 'Shoparize Init for Purchase sent');
    // Get ECommerce DataLayer
    const ec_dl = data.ecomm_datalayer;
    let ec = null;
    // Default EC DataLayer (dataLayer.ecommerce)
    if (typeof ec_dl=='string' && ec_dl=='default') {
      const ectmp = copyFromDataLayer('ecommerce');
      if (typeof ectmp=='object' && ectmp) {
        ec = JSON.parse(JSON.stringify(ectmp));
      } else {
        log('warn', 'Shoparize: ecommerce object not existing (or valid) as dataLayer.ecommerce: ', ectmp);
      }
      ec = copyFromDataLayer('ecommerce');
      if (typeof ec!='object' || !ec) {
        log('warn', 'Shoparize: ecommerce object not existing (or valid) in dataLayer! ECommerce Object: ', JSON.parse(JSON.stringify(ec)));
        ec = null;
      }
    }
    // Manual ECommerce Object
    else if (typeof ec_dl=='string' && ec_dl=='manual') {
      let items = null;
      // Default Items Object (dataLayer.ecommerce.items)
      if (typeof data.items=='string' && data.items=='default') {
        const ectmp = copyFromDataLayer('ecommerce');
        if (typeof ectmp=='object' && ectmp && typeof ectmp.items=='object') {
          items = JSON.parse(JSON.stringify(ectmp.items));
        } else {
          log('warn', 'Shoparize: ecommerce.items object not existing (or valid) in dataLayer! ECommerce Object: ', JSON.parse(JSON.stringify(ectmp)));
        }
      }
      // Other DataLayer Items Object
      else if (typeof data.items=='string' && data.items=='datalayer' && typeof data.item_field=='string' && data.item_field) {
        const itemstmp = copyFromDataLayer(data.item_field);
        if (typeof itemstmp=='object' && itemstmp) {
          items = JSON.parse(JSON.stringify(itemstmp));
        } else {
          log('warn', 'Shoparize: ecommerce.items object not existing (or valid) in dataLayer! ECommerce Object: ', JSON.parse(JSON.stringify(itemstmp)));
        }
      }
      // Items Object from a GTM Variable
      else {
        const itemstmp = data.items;
        if (typeof itemstmp=='object' && itemstmp) {
          items = JSON.parse(JSON.stringify(itemstmp));
        } else {
          log('warn', 'Shoparize: ecommerce.items object not existing (or valid) in given GTM variables! Given Variable Content: ', itemstmp);
        }
      }
      ec = {
        transaction_id: data.transaction_id,
        value: data.revenue,
        tax: data.tax,
        shipping: data.shipping,
        currency: data.currency,
        items: items
      };
    }
    // ECommerce Object from an GTM Variable
    else {
      const ectmp = data.ecomm_datalayer;
      if (typeof ectmp=='object' && ectmp) {
        ec = JSON.parse(JSON.stringify(ectmp));
      } else {
        log('warn', 'Shoparize: ecommerce object not existing (or valid) in given GTM variables! Given Variable Content: ', ectmp);
      }
    }
    //log('info', 'Shoparize ECommerce Object imported', JSON.parse(JSON.stringify(ec)));
    // Get/Create Shoparize DataLayer
    let sdl = copyFromWindow('dataLayerShoparize');
    if (typeof sdl!='object' || typeof sdl.length!='number') {
      setInWindow('dataLayerShoparize', [], true);
      sdl = copyFromWindow('dataLayerShoparize');
    }
    // Push EC Object
    const ec_obj = {
      event: 'purchase',
      ecommerce: ec
    };
    sdl.push(ec_obj);
    setInWindow('dataLayerShoparize', sdl, true);
    // Send Shoparize Conversion
    if (typeof srapi == 'object' && typeof srapi.conv == 'function') {
      srapi.conv(partner_id);
      log('info', 'Shoparize ECommerce Object sent to Shoparize', JSON.parse(JSON.stringify(sdl)));
    } else {
      log('error', 'Error by calling SHOPARIZE_API.conv');
      data.gtmOnFailure();
    }
    //log('info', 'Shoparize Purchae Conversion sent');
  }

};

// Error Handling
const onFailure = function() {
  log('error', 'Error by loading Shoparize Script');
  data.gtmOnFailure();
};

// Success Handling
const onSuccess = function() {
  trackShoparize();
  log('info', 'Shoparize Script for Partner Shop '+partner_id+' injected');
  data.gtmOnSuccess();
};

// Inject Script
//log('info', 'Require Shoparize Script for Partner Shop '+partner_id+' ...');
if (queryPermission('inject_script', shoparize_url)) {
  injectScript(shoparize_url, onSuccess, onFailure);
} else {
  log('error','Shoparize Script incection: No permissions to inject');
  data.gtmOnFailure();
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://*.shoparize.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "SHOPARIZE_API"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayerShoparize"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedKeys",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Pageview Test
  code: |-
    const mockData = {
      partner_id: "1234",
      pagetype: "normal"
    };

    mock('injectScript', function(url, onSuccess, onFailure) {
      onSuccess();
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
setup: ''


___NOTES___

# Shoparize GTM Template (unofficial)

- Version 1.1
- Autor: Andi Petzoldt <andi@petzoldt.net>
- Last Update: 12.03.2025

## Description

This (unofficial) GTM Template is for using the Shoparize (Tracking) API for an easier use of the Shoparize API.

## Repository

Find the Repository here:
https://github.com/Andiministrator/Shoparize

## Licence

Apache 2.0


